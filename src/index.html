<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biocom Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      color: #eee;
      min-height: 100vh;
      padding: 24px;
    }
    h1 { margin-bottom: 16px; color: #fff; font-size: 22px; }

    /* íƒ­ */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 1px solid #334155;
      padding-bottom: 0;
    }
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab:hover { color: #eee; }
    .tab.active {
      color: #4ade80;
      border-bottom-color: #4ade80;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ìƒíƒœë°” */
    .status-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 13px;
      flex-wrap: wrap;
      align-items: center;
    }
    .status-item {
      padding: 6px 12px;
      border-radius: 6px;
      background: #16213e;
      color: #94a3b8;
      font-size: 12px;
    }
    .status-item.running { background: #fbbf24; color: #1a1a2e; }
    .status-item.success { background: #4ade80; color: #1a1a2e; }
    .status-item.error { background: #ef4444; color: white; }

    /* ë²„íŠ¼ */
    .btn-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: white;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-deploy { background: #e94560; }
    .btn-deploy-dev { background: linear-gradient(90deg, #f59e0b, #e94560); }
    .btn-commit { background: #8b5cf6; }
    .btn-push { background: #3b82f6; }
    .btn-merge { background: #f59e0b; }
    .btn-commit-push { background: linear-gradient(90deg, #8b5cf6, #3b82f6); }
    .btn-all { background: #4ade80; color: #1a1a2e; }
    .btn-small {
      padding: 8px 14px;
      font-size: 12px;
    }

    /* í”„ë¡œì íŠ¸ ì¹´ë“œ */
    .project-cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
      max-width: 700px;
    }
    .project-card {
      background: rgba(22, 33, 62, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .project-info {
      min-width: 140px;
    }
    .project-name {
      font-weight: 600;
      color: #fff;
      font-size: 14px;
    }
    .project-path {
      font-size: 10px;
      color: #64748b;
      margin-top: 2px;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .project-actions {
      display: flex;
      gap: 8px;
    }

    /* ì„¤ì • */
    .config-section { margin-bottom: 16px; }
    .config-toggle {
      background: #334155;
      color: #94a3b8;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .config-panel {
      display: none;
      background: #16213e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .config-panel.show { display: block; }
    .config-title { margin: 0 0 16px 0; font-size: 16px; color: #fff; }
    .project-config {
      background: #0f3460;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .project-header { display: flex; gap: 8px; align-items: flex-start; }
    .label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
    .input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f0f23;
      color: #eee;
      font-size: 13px;
      box-sizing: border-box;
    }
    .config-field { margin-bottom: 8px; }
    .remove-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      flex-shrink: 0;
    }
    .add-btn {
      background: #334155;
      color: #94a3b8;
      border: 1px dashed #64748b;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 16px;
    }
    .config-btn-row { display: flex; gap: 8px; }
    .save-btn {
      background: #4ade80;
      color: #1a1a2e;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .cancel-btn {
      background: #64748b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* ë¡œê·¸ */
    .log-container {
      background: rgba(15, 15, 35, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
      height: calc(100vh - 400px);
      min-height: 200px;
      max-width: 700px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .log-line { white-space: pre-wrap; word-break: break-all; }
    .log-line.system { color: #4ade80; font-weight: 600; }
    .log-line.error { color: #ef4444; }

    /* í—¤ë” */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .help-btn {
      background: transparent;
      border: 1px solid #64748b;
      color: #94a3b8;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
    }
    .help-btn:hover { border-color: #94a3b8; color: #eee; }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #334155;
    }
    .modal h2 { margin-bottom: 16px; color: #fff; font-size: 18px; }
    .modal h3 { margin: 16px 0 8px; color: #4ade80; font-size: 14px; }
    .modal p, .modal li { font-size: 13px; color: #94a3b8; line-height: 1.6; }
    .modal ul { padding-left: 20px; margin-bottom: 12px; }
    .modal code {
      background: #0f0f23;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      color: #fbbf24;
    }
    .modal-close {
      background: #334155;
      color: #eee;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 16px;
    }

    /* Tools íƒ­ ìŠ¤íƒ€ì¼ */
    .tools-container {
      max-width: 700px;
    }
    .drop-zone {
      border: 3px dashed #4a4a6a;
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #16213e;
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: #7b68ee;
      background: #1a2a4e;
    }
    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    .drop-zone-text {
      font-size: 14px;
      color: #aaa;
    }
    .tools-settings {
      display: flex;
      align-items: center;
      gap: 20px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    .setting {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .setting label {
      color: #aaa;
      font-size: 13px;
    }
    .setting input[type="range"] {
      width: 100px;
    }
    .setting input[type="number"] {
      width: 50px;
      padding: 6px;
      border: 1px solid #4a4a6a;
      border-radius: 6px;
      background: #16213e;
      color: #eee;
      text-align: center;
      font-size: 13px;
    }
    .results {
      margin-top: 16px;
    }
    .result-item {
      background: #16213e;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .result-preview {
      width: 50px;
      height: 50px;
      object-fit: contain;
      border-radius: 6px;
      background: #0f0f1a;
    }
    .result-info {
      flex: 1;
      min-width: 0;
    }
    .result-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
      word-break: break-all;
    }
    .result-size {
      font-size: 12px;
      color: #888;
    }
    .result-size .reduction {
      color: #4ade80;
      font-weight: 600;
    }
    .result-size .increase {
      color: #f87171;
      font-weight: 600;
    }
    .result-download {
      padding: 8px 14px;
      background: #7b68ee;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: background 0.2s;
    }
    .result-download:hover {
      background: #6a5acd;
    }
    .download-all {
      display: none;
      width: 100%;
      padding: 14px;
      margin-top: 16px;
      background: #4ade80;
      color: #1a1a2e;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: background 0.2s;
    }
    .download-all:hover {
      background: #22c55e;
    }
    .download-all.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display:flex;align-items:center;gap:12px;">
      <h1>Biocom Dashboard</h1>
      <button class="help-btn" onclick="toggleHelp()">?</button>
    </div>
  </div>

  <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="help-modal" onclick="if(event.target===this)toggleHelp()">
    <div class="modal">
      <h2>Dashboard ì‚¬ìš© ê°€ì´ë“œ</h2>

      <h3>Deploy íƒ­</h3>
      <p>GCPì— í”„ë¡œì íŠ¸ë¥¼ ë°°í¬í•©ë‹ˆë‹¤.</p>
      <ul>
        <li><strong>Deploy to Dev</strong> - development ë¸Œëœì¹˜ì— ë¨¸ì§€ + í‘¸ì‹œ + ê°œë°œí™˜ê²½ ë°°í¬ (ì›í´ë¦­)</li>
        <li><strong>Deploy</strong> - í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰</li>
        <li><strong>Deploy All</strong> - ëª¨ë“  í”„ë¡œì íŠ¸ ìˆœì°¨ ë°°í¬</li>
      </ul>
      <p>ì„¤ì •ì—ì„œ <code>Project Path</code> (git root), <code>Deploy Script</code> (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ), <code>Deploy Project ID</code> (GCP í”„ë¡œì íŠ¸ ID)ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</p>

      <h3>Commit íƒ­</h3>
      <p>Claude Codeë¥¼ ì‚¬ìš©í•˜ì—¬ git ì‘ì—…ì„ ìë™í™”í•©ë‹ˆë‹¤.</p>
      <ul>
        <li><strong>Commit</strong> - Claudeê°€ diffë¥¼ ë¶„ì„í•˜ì—¬ ì»¤ë°‹ ë©”ì‹œì§€ ìë™ ìƒì„± ë° ì»¤ë°‹</li>
        <li><strong>Commit & Push</strong> - ì»¤ë°‹ í›„ development ë¸Œëœì¹˜ì— ë¨¸ì§€í•˜ê³  í‘¸ì‹œ</li>
        <li><strong>Merge to dev</strong> - í˜„ì¬ ë¸Œëœì¹˜ë¥¼ developmentì— ë¨¸ì§€í•˜ê³  í‘¸ì‹œ</li>
        <li><strong>Commit All</strong> - ëª¨ë“  í”„ë¡œì íŠ¸ ìˆœì°¨ ì»¤ë°‹</li>
        <li><strong>Push All</strong> - ëª¨ë“  í”„ë¡œì íŠ¸ ìˆœì°¨ í‘¸ì‹œ</li>
      </ul>

      <h3>í”„ë¡œì íŠ¸ ìë™ ìŠ¤ìº”</h3>
      <p>Commit Settingsì—ì„œ ìƒìœ„ ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ì…ë ¥í•˜ê³  <strong>Scan</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í•˜ìœ„ì˜ git í”„ë¡œì íŠ¸ë“¤ì„ ìë™ìœ¼ë¡œ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•©ë‹ˆë‹¤.</p>

      <h3>Claude CLI ì„¤ì •</h3>
      <p>Commit ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € <strong>Commit Settings</strong>ì—ì„œ Claude CLI ê²½ë¡œë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>
      <ul>
        <li>í„°ë¯¸ë„ì—ì„œ <code>which claude</code> ëª…ë ¹ìœ¼ë¡œ ê²½ë¡œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
        <li>ì˜ˆ: <code>/usr/local/bin/claude</code> ë˜ëŠ” nvm ì‚¬ìš© ì‹œ <code>/Users/username/.nvm/versions/node/v24.x.x/bin/claude</code></li>
      </ul>

      <h3>ì£¼ì˜ì‚¬í•­</h3>
      <ul>
        <li>Commit ê¸°ëŠ¥ì€ <code>--dangerously-skip-permissions</code> í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
        <li>development ë¸Œëœì¹˜ê°€ ìˆëŠ” í”„ë¡œì íŠ¸ì—ì„œë§Œ Merge to devê°€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.</li>
      </ul>

      <button class="modal-close" onclick="toggleHelp()">ë‹«ê¸°</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('deploy')">Deploy</button>
    <button class="tab" onclick="switchTab('commit')">Commit</button>
    <button class="tab" onclick="switchTab('tools')">Tools</button>
  </div>

  <!-- ë°°í¬ íƒ­ -->
  <div id="tab-deploy" class="tab-content active">
    <div class="status-bar" id="deploy-status-bar"></div>
    <div class="project-cards" id="deploy-cards"></div>
    <div class="btn-row">
      <button class="btn btn-all" onclick="deployAll()" id="btn-deploy-all">Deploy All</button>
    </div>
  </div>

  <!-- ì»¤ë°‹ íƒ­ -->
  <div id="tab-commit" class="tab-content">
    <div class="status-bar" id="commit-status-bar"></div>
    <div class="project-cards" id="commit-cards"></div>
    <div class="btn-row">
      <button class="btn btn-all" onclick="commitAll()" id="btn-commit-all">Commit All</button>
      <button class="btn btn-push" onclick="pushAll()" id="btn-push-all">Push All</button>
    </div>
  </div>

  <!-- Deploy ì„¤ì • íŒ¨ë„ -->
  <div id="deploy-config-section" class="config-section" style="display:none;">
    <button class="config-toggle" onclick="toggleConfig('deploy')">Deploy Settings</button>
  </div>
  <div class="config-panel" id="deploy-config-panel">
    <h3 class="config-title">Deploy Settings</h3>
    <div id="deploy-project-list"></div>
    <button class="add-btn" onclick="addProject('deploy')">+ Add Project</button>
    <div class="config-btn-row">
      <button class="save-btn" onclick="saveConfig('deploy')">Save</button>
      <button class="cancel-btn" onclick="cancelConfig('deploy')">Cancel</button>
    </div>
  </div>

  <!-- Tools íƒ­ -->
  <div id="tab-tools" class="tab-content">
    <div class="tools-container">
      <h2 style="margin-bottom: 20px; font-size: 18px;">PNG to WebP ë³€í™˜ê¸°</h2>

      <div class="drop-zone" id="dropZone">
        <div class="drop-zone-icon">ğŸ“</div>
        <p class="drop-zone-text">
          ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ <span style="color:#7b68ee;text-decoration:underline;cursor:pointer;">í´ë¦­í•˜ì—¬ ì„ íƒ</span>
        </p>
        <input type="file" id="fileInput" accept=".png,.jpg,.jpeg" multiple style="display:none;">
      </div>

      <div class="tools-settings">
        <div class="setting">
          <label>í’ˆì§ˆ:</label>
          <input type="range" id="quality" min="1" max="100" value="80">
          <input type="number" id="qualityNum" min="1" max="100" value="80">
        </div>
        <button class="btn btn-small" style="background:#ef4444;" onclick="clearResults()">ì´ˆê¸°í™”</button>
      </div>

      <div class="results" id="results"></div>
      <button class="download-all" id="downloadAll">ì „ì²´ ë‹¤ìš´ë¡œë“œ (ZIP)</button>
    </div>
  </div>

  <!-- Commit ì„¤ì • íŒ¨ë„ -->
  <div id="commit-config-section" class="config-section" style="display:none;">
    <button class="config-toggle" onclick="toggleConfig('commit')">Commit Settings</button>
  </div>
  <div class="config-panel" id="commit-config-panel">
    <h3 class="config-title">Commit Settings</h3>
    <div class="config-field" style="margin-bottom:16px;">
      <label class="label">Claude CLI Path (í•„ìˆ˜: claude ì‹¤í–‰ íŒŒì¼ ê²½ë¡œ)</label>
      <input class="input" id="commit-claude-path" placeholder="/path/to/claude (ì˜ˆ: /usr/local/bin/claude ë˜ëŠ” which claude ê²°ê³¼)">
    </div>
    <div class="config-field" style="margin-bottom:16px;">
      <label class="label">Scan Root Path (ìƒìœ„ ë””ë ‰í† ë¦¬ ì…ë ¥ ì‹œ í•˜ìœ„ git í”„ë¡œì íŠ¸ ìë™ ê²€ìƒ‰)</label>
      <div style="display:flex;gap:8px;">
        <input class="input" id="commit-scan-path" placeholder="/path/to/parent/directory" style="flex:1;">
        <button class="btn btn-push btn-small" onclick="scanGitProjects()">Scan</button>
      </div>
    </div>
    <div id="commit-project-list"></div>
    <button class="add-btn" onclick="addProject('commit')">+ Add Project</button>
    <div class="config-btn-row">
      <button class="save-btn" onclick="saveConfig('commit')">Save</button>
      <button class="cancel-btn" onclick="cancelConfig('commit')">Cancel</button>
    </div>
  </div>

  <div class="log-container" id="log"></div>

  <script>
    // íƒ­ë³„ ê¸°ë³¸ ì„¤ì •
    const DEFAULT_DEPLOY_CONFIG = {
      projects: [
        {
          id: 'biocom-api',
          label: 'biocom-api',
          path: '/Users/shinwoo/Desktop/Biocom/repo/biocom-api',
          deployScript: '/Users/shinwoo/Desktop/Biocom/repo/biocom-api/infra-gcp/scripts/02-deploy-app.sh',
          deployProjectId: 'api-dev-biocom'
        },
        {
          id: 'biocom-bo-api',
          label: 'biocom-bo-api',
          path: '/Users/shinwoo/Desktop/Biocom/repo/biocom-bo-api',
          deployScript: '/Users/shinwoo/Desktop/Biocom/repo/biocom-bo-api/infra-gcp/scripts/02-deploy-app.sh',
          deployProjectId: 'biocom-backoffice'
        }
      ]
    };

    const DEFAULT_COMMIT_CONFIG = {
      claudePath: '',
      projects: [
        { id: 'biocom-api', label: 'biocom-api', path: '/Users/shinwoo/Desktop/Biocom/repo/biocom-api' },
        { id: 'biocom-bo-api', label: 'biocom-bo-api', path: '/Users/shinwoo/Desktop/Biocom/repo/biocom-bo-api' },
        { id: 'biocom-admin', label: 'biocom-admin', path: '/Users/shinwoo/Desktop/Biocom/repo/biocom-admin' }
      ]
    };

    const COLORS = ['#e94560', '#3b82f6', '#8b5cf6', '#f59e0b', '#10b981', '#ec4899'];
    let deployConfig = null;
    let commitConfig = null;
    let editDeployConfig = null;
    let editCommitConfig = null;
    let statuses = {};
    let isRunning = false;
    let currentTab = 'deploy';

    function loadConfig() {
      // íƒ­ë³„ ì„¤ì • ë¡œë“œ
      const savedDeploy = localStorage.getItem('dashboard-deploy-config');
      const savedCommit = localStorage.getItem('dashboard-commit-config');
      deployConfig = savedDeploy ? JSON.parse(savedDeploy) : DEFAULT_DEPLOY_CONFIG;
      commitConfig = savedCommit ? JSON.parse(savedCommit) : DEFAULT_COMMIT_CONFIG;

      // ìƒíƒœ ì´ˆê¸°í™”
      deployConfig.projects.forEach(p => {
        statuses[`deploy-${p.id}`] = 'ready';
      });
      commitConfig.projects.forEach(p => {
        statuses[`commit-${p.id}`] = 'ready';
      });

      // ì €ì¥ëœ íƒ­ ë³µì›
      const savedTab = localStorage.getItem('dashboard-current-tab');
      if (savedTab) {
        currentTab = savedTab;
        switchTab(currentTab);
      }
      render();
    }

    function switchTab(tab) {
      currentTab = tab;
      localStorage.setItem('dashboard-current-tab', tab);
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const tabIndex = { deploy: 1, commit: 2, tools: 3 }[tab] || 1;
      document.querySelector(`.tab:nth-child(${tabIndex})`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');

      // íƒ­ë³„ ì„¤ì • ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
      document.getElementById('deploy-config-section').style.display = tab === 'deploy' ? 'block' : 'none';
      document.getElementById('commit-config-section').style.display = tab === 'commit' ? 'block' : 'none';
      // ì„¤ì • íŒ¨ë„ ë‹«ê¸°
      document.getElementById('deploy-config-panel').classList.remove('show');
      document.getElementById('commit-config-panel').classList.remove('show');
      // Tools íƒ­ì¼ ë•Œ ë¡œê·¸ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
      document.getElementById('log').style.display = tab === 'tools' ? 'none' : 'block';
    }

    function render() {
      renderDeployTab();
      renderCommitTab();
    }

    function renderDeployTab() {
      const statusBar = document.getElementById('deploy-status-bar');
      const cards = document.getElementById('deploy-cards');

      statusBar.innerHTML = deployConfig.projects.map(p => {
        const status = statuses[`deploy-${p.id}`] || 'ready';
        return `<div class="status-item ${status}">${p.label}: ${getStatusText(status)}</div>`;
      }).join('');

      cards.innerHTML = deployConfig.projects.map(p => `
        <div class="project-card">
          <div class="project-info">
            <div class="project-name">${p.label}</div>
            <div class="project-path" title="${p.deployScript}">${p.deployScript}</div>
          </div>
          <div class="project-actions">
            <button class="btn btn-deploy-dev btn-small" onclick="deployToDev('${p.id}')" ${isRunning ? 'disabled' : ''} title="Merge to dev + Deploy">Deploy to Dev</button>
            <button class="btn btn-deploy btn-small" onclick="deploy('${p.id}')" ${isRunning ? 'disabled' : ''}>Deploy</button>
          </div>
        </div>
      `).join('');

      document.getElementById('btn-deploy-all').disabled = isRunning;
    }

    function renderCommitTab() {
      const statusBar = document.getElementById('commit-status-bar');
      const cards = document.getElementById('commit-cards');

      statusBar.innerHTML = commitConfig.projects.map(p => {
        const status = statuses[`commit-${p.id}`] || 'ready';
        return `<div class="status-item ${status}">${p.label}: ${getStatusText(status)}</div>`;
      }).join('');

      cards.innerHTML = commitConfig.projects.map(p => `
        <div class="project-card">
          <div class="project-info">
            <div class="project-name">${p.label}</div>
            <div class="project-path" title="${p.path}">${p.path}</div>
          </div>
          <div class="project-actions">
            <button class="btn btn-commit btn-small" onclick="commit('${p.id}')" ${isRunning ? 'disabled' : ''}>Commit</button>
            <button class="btn btn-commit-push btn-small" onclick="commitAndPushDev('${p.id}')" ${isRunning ? 'disabled' : ''}>Commit & Push</button>
            <button class="btn btn-merge btn-small" onclick="mergeAndPush('${p.id}')" ${isRunning ? 'disabled' : ''}>Merge to dev</button>
          </div>
        </div>
      `).join('');

      document.getElementById('btn-commit-all').disabled = isRunning;
      document.getElementById('btn-push-all').disabled = isRunning;
    }

    function getStatusText(status) {
      switch(status) {
        case 'running': return 'Running...';
        case 'success': return 'Success';
        case 'error': return 'Failed';
        default: return 'Ready';
      }
    }

    function setStatus(projectId, type, status) {
      statuses[`${type}-${projectId}`] = status;
      render();
    }

    function addLog(text, className = '') {
      const log = document.getElementById('log');
      const div = document.createElement('div');
      div.className = `log-line ${className}`;
      div.textContent = text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // ===== Deploy =====
    async function deploy(projectId) {
      if (isRunning) return;
      const project = deployConfig.projects.find(p => p.id === projectId);
      if (!project?.deployScript) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Deploying ${project.label}...`, 'system');
      setStatus(projectId, 'deploy', 'running');

      await runSSE(`/api/deploy?projectId=${encodeURIComponent(project.deployProjectId)}&script=${encodeURIComponent(project.deployScript)}`, projectId, 'deploy', project.label);

      isRunning = false;
      render();
    }

    async function deployAll() {
      if (isRunning) return;
      isRunning = true;
      render();
      clearLog();

      for (const project of deployConfig.projects) {
        addLog(`[START] Deploying ${project.label}...`, 'system');
        setStatus(project.id, 'deploy', 'running');
        await runSSE(`/api/deploy?projectId=${encodeURIComponent(project.deployProjectId)}&script=${encodeURIComponent(project.deployScript)}`, project.id, 'deploy', project.label);
        addLog('');
      }

      addLog('[COMPLETE] All deployments finished!', 'system');
      isRunning = false;
      render();
    }

    // Deploy to Dev (Merge to development + Deploy)
    async function deployToDev(projectId) {
      if (isRunning) return;
      const project = deployConfig.projects.find(p => p.id === projectId);
      if (!project?.deployScript || !project?.path) {
        alert('Project path ë˜ëŠ” Deploy Scriptê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nDeploy Settingsì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
        return;
      }

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Deploy to Dev: ${project.label}...`, 'system');
      addLog(`  â†’ Merge to development + Push + Deploy`, 'system');
      setStatus(projectId, 'deploy', 'running');

      await runSSE(
        `/api/deploy-dev?cwd=${encodeURIComponent(project.path)}&script=${encodeURIComponent(project.deployScript)}&projectId=${encodeURIComponent(project.deployProjectId)}`,
        projectId, 'deploy', project.label
      );

      isRunning = false;
      render();
    }

    // ===== Commit =====
    function getClaudePath() {
      if (!commitConfig.claudePath) {
        alert('Claude CLI ê²½ë¡œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nCommit Settingsì—ì„œ Claude CLI Pathë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\ní„°ë¯¸ë„ì—ì„œ "which claude" ëª…ë ¹ìœ¼ë¡œ ê²½ë¡œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return null;
      }
      return commitConfig.claudePath;
    }

    async function commit(projectId) {
      if (isRunning) return;
      const claudePath = getClaudePath();
      if (!claudePath) return;

      const project = commitConfig.projects.find(p => p.id === projectId);
      if (!project) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Committing ${project.label}...`, 'system');
      setStatus(projectId, 'commit', 'running');

      await runSSE(`/api/commit?cwd=${encodeURIComponent(project.path)}&claudePath=${encodeURIComponent(claudePath)}`, projectId, 'commit', project.label);

      isRunning = false;
      render();
    }

    async function commitAll() {
      if (isRunning) return;
      const claudePath = getClaudePath();
      if (!claudePath) return;

      isRunning = true;
      render();
      clearLog();

      for (const project of commitConfig.projects) {
        addLog(`[START] Committing ${project.label}...`, 'system');
        setStatus(project.id, 'commit', 'running');
        await runSSE(`/api/commit?cwd=${encodeURIComponent(project.path)}&claudePath=${encodeURIComponent(claudePath)}`, project.id, 'commit', project.label);
        addLog('');
      }

      addLog('[COMPLETE] All commits finished!', 'system');
      isRunning = false;
      render();
    }

    // ===== Push =====
    async function push(projectId) {
      if (isRunning) return;
      const project = commitConfig.projects.find(p => p.id === projectId);
      if (!project) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Pushing ${project.label}...`, 'system');
      setStatus(projectId, 'commit', 'running');

      await runSSE(`/api/push?cwd=${encodeURIComponent(project.path)}`, projectId, 'commit', project.label);

      isRunning = false;
      render();
    }

    async function pushAll() {
      if (isRunning) return;
      isRunning = true;
      render();
      clearLog();

      for (const project of commitConfig.projects) {
        addLog(`[START] Pushing ${project.label}...`, 'system');
        setStatus(project.id, 'commit', 'running');
        await runSSE(`/api/push?cwd=${encodeURIComponent(project.path)}`, project.id, 'commit', project.label);
        addLog('');
      }

      addLog('[COMPLETE] All pushes finished!', 'system');
      isRunning = false;
      render();
    }

    // ===== Commit & Push to dev =====
    async function commitAndPushDev(projectId) {
      if (isRunning) return;
      const claudePath = getClaudePath();
      if (!claudePath) return;

      const project = commitConfig.projects.find(p => p.id === projectId);
      if (!project) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Commit & Push ${project.label} to development...`, 'system');
      setStatus(projectId, 'commit', 'running');

      await runSSE(`/api/commit-and-push-dev?cwd=${encodeURIComponent(project.path)}&claudePath=${encodeURIComponent(claudePath)}`, projectId, 'commit', project.label);

      isRunning = false;
      render();
    }

    // ===== Merge to dev =====
    async function mergeAndPush(projectId) {
      if (isRunning) return;
      const project = commitConfig.projects.find(p => p.id === projectId);
      if (!project) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Merging ${project.label} to development...`, 'system');
      setStatus(projectId, 'commit', 'running');

      await runSSE(`/api/merge-dev?cwd=${encodeURIComponent(project.path)}`, projectId, 'commit', project.label);

      isRunning = false;
      render();
    }

    // ===== SSE Runner =====
    function runSSE(url, projectId, type, label) {
      return new Promise((resolve) => {
        const eventSource = new EventSource(url);

        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'stdout' || data.type === 'stderr') {
            addLog(data.text);
          } else if (data.type === 'done') {
            eventSource.close();
            if (data.code === 0) {
              addLog(`[DONE] ${label} completed successfully!`, 'system');
              setStatus(projectId, type, 'success');
            } else {
              addLog(`[ERROR] ${label} failed (exit code: ${data.code})`, 'error');
              setStatus(projectId, type, 'error');
            }
            resolve();
          } else if (data.type === 'error') {
            eventSource.close();
            addLog(`[ERROR] ${data.text}`, 'error');
            setStatus(projectId, type, 'error');
            resolve();
          }
        };

        eventSource.onerror = () => {
          eventSource.close();
          addLog('[ERROR] Connection error', 'error');
          setStatus(projectId, type, 'error');
          resolve();
        };
      });
    }

    // ===== Config =====
    function toggleConfig(tab) {
      const panel = document.getElementById(`${tab}-config-panel`);
      if (panel.classList.contains('show')) {
        panel.classList.remove('show');
      } else {
        if (tab === 'deploy') {
          editDeployConfig = JSON.parse(JSON.stringify(deployConfig));
        } else {
          editCommitConfig = JSON.parse(JSON.stringify(commitConfig));
          // Claude ê²½ë¡œ ë° ìŠ¤ìº” ê²½ë¡œ ë³µì›
          setTimeout(() => {
            const claudeInput = document.getElementById('commit-claude-path');
            if (claudeInput) claudeInput.value = editCommitConfig.claudePath || '';
            restoreScanPath();
          }, 0);
        }
        renderConfigPanel(tab);
        panel.classList.add('show');
      }
    }

    function renderConfigPanel(tab) {
      const container = document.getElementById(`${tab}-project-list`);
      if (tab === 'deploy') {
        container.innerHTML = editDeployConfig.projects.map((p, i) => `
          <div class="project-config">
            <div class="project-header">
              <input class="input" style="font-weight:600;margin-bottom:8px;flex:1" value="${p.label}" placeholder="Label" onchange="updateEditProject('deploy', ${i}, 'label', this.value)">
              <button class="remove-btn" onclick="removeEditProject('deploy', ${i})">X</button>
            </div>
            <div class="config-field">
              <label class="label">Project Path (git root, Deploy to Devì— í•„ìš”)</label>
              <input class="input" value="${p.path || ''}" placeholder="/path/to/project" onchange="updateEditProject('deploy', ${i}, 'path', this.value)">
            </div>
            <div class="config-field">
              <label class="label">Deploy Script</label>
              <input class="input" value="${p.deployScript || ''}" placeholder="/path/to/deploy-script.sh" onchange="updateEditProject('deploy', ${i}, 'deployScript', this.value)">
            </div>
            <div class="config-field">
              <label class="label">Deploy Project ID</label>
              <input class="input" value="${p.deployProjectId || ''}" placeholder="gcp-project-id" onchange="updateEditProject('deploy', ${i}, 'deployProjectId', this.value)">
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = editCommitConfig.projects.map((p, i) => `
          <div class="project-config">
            <div class="project-header">
              <input class="input" style="font-weight:600;margin-bottom:8px;flex:1" value="${p.label}" placeholder="Label" onchange="updateEditProject('commit', ${i}, 'label', this.value)">
              <button class="remove-btn" onclick="removeEditProject('commit', ${i})">X</button>
            </div>
            <div class="config-field">
              <label class="label">Project Path (git root)</label>
              <input class="input" value="${p.path || ''}" placeholder="/path/to/project" onchange="updateEditProject('commit', ${i}, 'path', this.value)">
            </div>
          </div>
        `).join('');
      }
    }

    function updateEditProject(tab, index, field, value) {
      const config = tab === 'deploy' ? editDeployConfig : editCommitConfig;
      config.projects[index][field] = value;
      if (field === 'label') {
        config.projects[index].id = value.toLowerCase().replace(/\s+/g, '-');
      }
    }

    function addProject(tab) {
      const config = tab === 'deploy' ? editDeployConfig : editCommitConfig;
      if (tab === 'deploy') {
        config.projects.push({
          id: `project-${Date.now()}`,
          label: 'New Project',
          path: '',
          deployScript: '',
          deployProjectId: ''
        });
      } else {
        config.projects.push({
          id: `project-${Date.now()}`,
          label: 'New Project',
          path: ''
        });
      }
      renderConfigPanel(tab);
    }

    function removeEditProject(tab, index) {
      const config = tab === 'deploy' ? editDeployConfig : editCommitConfig;
      config.projects.splice(index, 1);
      renderConfigPanel(tab);
    }

    function saveConfig(tab) {
      if (tab === 'deploy') {
        deployConfig = editDeployConfig;
        localStorage.setItem('dashboard-deploy-config', JSON.stringify(deployConfig));
        deployConfig.projects.forEach(p => { statuses[`deploy-${p.id}`] = 'ready'; });
      } else {
        // Claude ê²½ë¡œ ì €ì¥
        const claudeInput = document.getElementById('commit-claude-path');
        if (claudeInput) editCommitConfig.claudePath = claudeInput.value.trim();
        commitConfig = editCommitConfig;
        localStorage.setItem('dashboard-commit-config', JSON.stringify(commitConfig));
        commitConfig.projects.forEach(p => { statuses[`commit-${p.id}`] = 'ready'; });
      }
      document.getElementById(`${tab}-config-panel`).classList.remove('show');
      render();
    }

    function cancelConfig(tab) {
      document.getElementById(`${tab}-config-panel`).classList.remove('show');
    }

    // Git í”„ë¡œì íŠ¸ ìë™ ìŠ¤ìº”
    async function scanGitProjects() {
      const pathInput = document.getElementById('commit-scan-path');
      const rootPath = pathInput.value.trim();
      if (!rootPath) {
        alert('ìŠ¤ìº”í•  ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      try {
        const res = await fetch(`/api/scan-git-projects?path=${encodeURIComponent(rootPath)}`);
        const data = await res.json();

        if (data.error) {
          alert(`ìŠ¤ìº” ì‹¤íŒ¨: ${data.error}`);
          return;
        }

        if (data.projects.length === 0) {
          alert('í•´ë‹¹ ê²½ë¡œì—ì„œ git í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ê¸°ì¡´ í”„ë¡œì íŠ¸ì™€ ë³‘í•© (ì¤‘ë³µ ì œê±°)
        const existingPaths = new Set(editCommitConfig.projects.map(p => p.path));
        for (const project of data.projects) {
          if (!existingPaths.has(project.path)) {
            editCommitConfig.projects.push(project);
          }
        }

        // ìŠ¤ìº” ê²½ë¡œ ì €ì¥
        localStorage.setItem('dashboard-commit-scan-path', rootPath);

        renderConfigPanel('commit');
        alert(`${data.projects.length}ê°œì˜ git í”„ë¡œì íŠ¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
      } catch (err) {
        alert(`ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
      }
    }

    // ì €ì¥ëœ ìŠ¤ìº” ê²½ë¡œ ë³µì›
    function restoreScanPath() {
      const savedPath = localStorage.getItem('dashboard-commit-scan-path');
      if (savedPath) {
        const input = document.getElementById('commit-scan-path');
        if (input) input.value = savedPath;
      }
    }

    // ë„ì›€ë§ ëª¨ë‹¬ í† ê¸€
    function toggleHelp() {
      const modal = document.getElementById('help-modal');
      modal.classList.toggle('show');
    }

    loadConfig();
    // ì´ˆê¸° íƒ­ ì„¤ì • ë²„íŠ¼ í‘œì‹œ
    switchTab(currentTab);

    // ===== Tools: PNG to WebP =====
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const resultsContainer = document.getElementById('results');
    const downloadAllBtn = document.getElementById('downloadAll');
    const qualitySlider = document.getElementById('quality');
    const qualityNumInput = document.getElementById('qualityNum');

    let convertedFiles = [];

    // í’ˆì§ˆ ìŠ¬ë¼ì´ë” ë™ê¸°í™”
    qualitySlider.addEventListener('input', () => {
      qualityNumInput.value = qualitySlider.value;
    });
    qualityNumInput.addEventListener('input', () => {
      qualitySlider.value = qualityNumInput.value;
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleImageFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', () => {
      handleImageFiles(fileInput.files);
    });

    async function handleImageFiles(files) {
      const quality = parseInt(qualityNumInput.value);

      for (const file of files) {
        if (!file.type.match(/image\/(png|jpeg|jpg)/)) continue;

        const { webpBlob, originalSize, newSize } = await convertToWebP(file, quality);
        const reduction = ((originalSize - newSize) / originalSize * 100).toFixed(1);

        const newName = file.name.replace(/\.(png|jpg|jpeg)$/i, '.webp');

        convertedFiles.push({ name: newName, blob: webpBlob });

        // ê²°ê³¼ í‘œì‹œ
        const item = document.createElement('div');
        item.className = 'result-item';

        const previewUrl = URL.createObjectURL(webpBlob);
        const isReduced = newSize < originalSize;

        item.innerHTML = `
          <img src="${previewUrl}" class="result-preview" alt="preview">
          <div class="result-info">
            <div class="result-name">${newName}</div>
            <div class="result-size">
              ${formatFileSize(originalSize)} â†’ ${formatFileSize(newSize)}
              <span class="${isReduced ? 'reduction' : 'increase'}">
                (${isReduced ? '-' : '+'}${Math.abs(reduction)}%)
              </span>
            </div>
          </div>
          <button class="result-download">ë‹¤ìš´ë¡œë“œ</button>
        `;

        item.querySelector('.result-download').addEventListener('click', () => {
          downloadConvertedFile(webpBlob, newName);
        });

        resultsContainer.appendChild(item);
      }

      if (convertedFiles.length > 1) {
        downloadAllBtn.classList.add('show');
      }
    }

    async function convertToWebP(file, quality) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('quality', quality.toString());

      const response = await fetch('/api/convert-webp', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        throw new Error('Conversion failed');
      }

      const webpBlob = await response.blob();
      const originalSize = parseInt(response.headers.get('X-Original-Size') || '0');
      const newSize = parseInt(response.headers.get('X-Converted-Size') || '0');

      return { webpBlob, originalSize, newSize };
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function downloadConvertedFile(blob, name) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearResults() {
      convertedFiles = [];
      resultsContainer.innerHTML = '';
      downloadAllBtn.classList.remove('show');
      fileInput.value = '';
    }

    // ZIP ë‹¤ìš´ë¡œë“œ (JSZip CDN ë™ì  ë¡œë“œ)
    downloadAllBtn.addEventListener('click', async () => {
      if (!window.JSZip) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        script.onload = () => createAndDownloadZip();
        document.head.appendChild(script);
      } else {
        createAndDownloadZip();
      }
    });

    async function createAndDownloadZip() {
      const zip = new JSZip();

      for (const file of convertedFiles) {
        zip.file(file.name, file.blob);
      }

      const content = await zip.generateAsync({ type: 'blob' });
      downloadConvertedFile(content, 'converted-webp.zip');
    }
  </script>
</body>
</html>
