<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biocom Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      color: #eee;
      min-height: 100vh;
      padding: 24px;
    }
    h1 { margin-bottom: 16px; color: #fff; font-size: 22px; }

    /* 탭 */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 1px solid #334155;
      padding-bottom: 0;
    }
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab:hover { color: #eee; }
    .tab.active {
      color: #4ade80;
      border-bottom-color: #4ade80;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* 상태바 */
    .status-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 13px;
      flex-wrap: wrap;
      align-items: center;
    }
    .status-item {
      padding: 6px 12px;
      border-radius: 6px;
      background: #16213e;
      color: #94a3b8;
      font-size: 12px;
    }
    .status-item.running { background: #fbbf24; color: #1a1a2e; }
    .status-item.success { background: #4ade80; color: #1a1a2e; }
    .status-item.error { background: #ef4444; color: white; }

    /* 버튼 */
    .btn-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: white;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-deploy { background: #e94560; }
    .btn-commit { background: #8b5cf6; }
    .btn-push { background: #3b82f6; }
    .btn-merge { background: #f59e0b; }
    .btn-commit-push { background: linear-gradient(90deg, #8b5cf6, #3b82f6); }
    .btn-all { background: #4ade80; color: #1a1a2e; }
    .btn-small {
      padding: 8px 14px;
      font-size: 12px;
    }

    /* 프로젝트 카드 */
    .project-cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
      max-width: 700px;
    }
    .project-card {
      background: rgba(22, 33, 62, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .project-info {
      min-width: 140px;
    }
    .project-name {
      font-weight: 600;
      color: #fff;
      font-size: 14px;
    }
    .project-path {
      font-size: 10px;
      color: #64748b;
      margin-top: 2px;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .project-actions {
      display: flex;
      gap: 8px;
    }

    /* 설정 */
    .config-section { margin-bottom: 16px; }
    .config-toggle {
      background: #334155;
      color: #94a3b8;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .config-panel {
      display: none;
      background: #16213e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .config-panel.show { display: block; }
    .config-title { margin: 0 0 16px 0; font-size: 16px; color: #fff; }
    .project-config {
      background: #0f3460;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .project-header { display: flex; gap: 8px; align-items: flex-start; }
    .label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
    .input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f0f23;
      color: #eee;
      font-size: 13px;
      box-sizing: border-box;
    }
    .config-field { margin-bottom: 8px; }
    .remove-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      flex-shrink: 0;
    }
    .add-btn {
      background: #334155;
      color: #94a3b8;
      border: 1px dashed #64748b;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 16px;
    }
    .config-btn-row { display: flex; gap: 8px; }
    .save-btn {
      background: #4ade80;
      color: #1a1a2e;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .cancel-btn {
      background: #64748b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* 로그 */
    .log-container {
      background: rgba(15, 15, 35, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
      height: calc(100vh - 400px);
      min-height: 200px;
      max-width: 700px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .log-line { white-space: pre-wrap; word-break: break-all; }
    .log-line.system { color: #4ade80; font-weight: 600; }
    .log-line.error { color: #ef4444; }

    /* 헤더 */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .help-btn {
      background: transparent;
      border: 1px solid #64748b;
      color: #94a3b8;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
    }
    .help-btn:hover { border-color: #94a3b8; color: #eee; }

    /* 모달 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #334155;
    }
    .modal h2 { margin-bottom: 16px; color: #fff; font-size: 18px; }
    .modal h3 { margin: 16px 0 8px; color: #4ade80; font-size: 14px; }
    .modal p, .modal li { font-size: 13px; color: #94a3b8; line-height: 1.6; }
    .modal ul { padding-left: 20px; margin-bottom: 12px; }
    .modal code {
      background: #0f0f23;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      color: #fbbf24;
    }
    .modal-close {
      background: #334155;
      color: #eee;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display:flex;align-items:center;gap:12px;">
      <h1>Biocom Dashboard</h1>
      <button class="help-btn" onclick="toggleHelp()">?</button>
    </div>
  </div>

  <!-- 도움말 모달 -->
  <div class="modal-overlay" id="help-modal" onclick="if(event.target===this)toggleHelp()">
    <div class="modal">
      <h2>Dashboard 사용 가이드</h2>

      <h3>Deploy 탭</h3>
      <p>GCP에 프로젝트를 배포합니다.</p>
      <ul>
        <li><strong>Deploy</strong> - 해당 프로젝트의 배포 스크립트 실행</li>
        <li><strong>Deploy All</strong> - 모든 프로젝트 순차 배포</li>
      </ul>
      <p>설정에서 <code>Deploy Script</code> (배포 스크립트 경로)와 <code>Deploy Project ID</code> (GCP 프로젝트 ID)를 지정합니다.</p>

      <h3>Commit 탭</h3>
      <p>Claude Code를 사용하여 git 작업을 자동화합니다.</p>
      <ul>
        <li><strong>Commit</strong> - Claude가 diff를 분석하여 커밋 메시지 자동 생성 및 커밋</li>
        <li><strong>Commit & Push</strong> - 커밋 후 development 브랜치에 머지하고 푸시</li>
        <li><strong>Merge to dev</strong> - 현재 브랜치를 development에 머지하고 푸시</li>
        <li><strong>Commit All</strong> - 모든 프로젝트 순차 커밋</li>
        <li><strong>Push All</strong> - 모든 프로젝트 순차 푸시</li>
      </ul>

      <h3>프로젝트 자동 스캔</h3>
      <p>Commit Settings에서 상위 디렉토리 경로를 입력하고 <strong>Scan</strong> 버튼을 클릭하면 하위의 git 프로젝트들을 자동으로 검색하여 추가합니다.</p>

      <h3>주의사항</h3>
      <ul>
        <li>Claude CLI 경로가 <code>/Users/shinwoo/.nvm/versions/node/v24.2.0/bin/claude</code>로 하드코딩되어 있습니다.</li>
        <li>Commit 기능은 <code>--dangerously-skip-permissions</code> 플래그를 사용합니다.</li>
        <li>development 브랜치가 있는 프로젝트에서만 Merge to dev가 정상 작동합니다.</li>
      </ul>

      <button class="modal-close" onclick="toggleHelp()">닫기</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('deploy')">Deploy</button>
    <button class="tab" onclick="switchTab('commit')">Commit</button>
  </div>

  <!-- 배포 탭 -->
  <div id="tab-deploy" class="tab-content active">
    <div class="status-bar" id="deploy-status-bar"></div>
    <div class="project-cards" id="deploy-cards"></div>
    <div class="btn-row">
      <button class="btn btn-all" onclick="deployAll()" id="btn-deploy-all">Deploy All</button>
    </div>
  </div>

  <!-- 커밋 탭 -->
  <div id="tab-commit" class="tab-content">
    <div class="status-bar" id="commit-status-bar"></div>
    <div class="project-cards" id="commit-cards"></div>
    <div class="btn-row">
      <button class="btn btn-all" onclick="commitAll()" id="btn-commit-all">Commit All</button>
      <button class="btn btn-push" onclick="pushAll()" id="btn-push-all">Push All</button>
    </div>
  </div>

  <!-- Deploy 설정 패널 -->
  <div id="deploy-config-section" class="config-section" style="display:none;">
    <button class="config-toggle" onclick="toggleConfig('deploy')">Deploy Settings</button>
  </div>
  <div class="config-panel" id="deploy-config-panel">
    <h3 class="config-title">Deploy Settings</h3>
    <div id="deploy-project-list"></div>
    <button class="add-btn" onclick="addProject('deploy')">+ Add Project</button>
    <div class="config-btn-row">
      <button class="save-btn" onclick="saveConfig('deploy')">Save</button>
      <button class="cancel-btn" onclick="cancelConfig('deploy')">Cancel</button>
    </div>
  </div>

  <!-- Commit 설정 패널 -->
  <div id="commit-config-section" class="config-section" style="display:none;">
    <button class="config-toggle" onclick="toggleConfig('commit')">Commit Settings</button>
  </div>
  <div class="config-panel" id="commit-config-panel">
    <h3 class="config-title">Commit Settings</h3>
    <div class="config-field" style="margin-bottom:16px;">
      <label class="label">Scan Root Path (상위 디렉토리 입력 시 하위 git 프로젝트 자동 검색)</label>
      <div style="display:flex;gap:8px;">
        <input class="input" id="commit-scan-path" placeholder="/path/to/parent/directory" style="flex:1;">
        <button class="btn btn-push btn-small" onclick="scanGitProjects()">Scan</button>
      </div>
    </div>
    <div id="commit-project-list"></div>
    <button class="add-btn" onclick="addProject('commit')">+ Add Project</button>
    <div class="config-btn-row">
      <button class="save-btn" onclick="saveConfig('commit')">Save</button>
      <button class="cancel-btn" onclick="cancelConfig('commit')">Cancel</button>
    </div>
  </div>

  <div class="log-container" id="log"></div>

  <script>
    // 탭별 기본 설정
    const DEFAULT_DEPLOY_CONFIG = {
      projects: [
        {
          id: 'biocom-api',
          label: 'biocom-api',
          deployScript: '/Users/shinwoo/Desktop/Biocom/repo/biocom-api/infra-gcp/scripts/02-deploy-app.sh',
          deployProjectId: 'api-dev-biocom'
        },
        {
          id: 'biocom-bo-api',
          label: 'biocom-bo-api',
          deployScript: '/Users/shinwoo/Desktop/Biocom/repo/biocom-bo-api/infra-gcp/scripts/02-deploy-app.sh',
          deployProjectId: 'biocom-backoffice'
        }
      ]
    };

    const DEFAULT_COMMIT_CONFIG = {
      projects: [
        { id: 'biocom-api', label: 'biocom-api', path: '/Users/shinwoo/Desktop/Biocom/repo/biocom-api' },
        { id: 'biocom-bo-api', label: 'biocom-bo-api', path: '/Users/shinwoo/Desktop/Biocom/repo/biocom-bo-api' },
        { id: 'biocom-admin', label: 'biocom-admin', path: '/Users/shinwoo/Desktop/Biocom/repo/biocom-admin' }
      ]
    };

    const COLORS = ['#e94560', '#3b82f6', '#8b5cf6', '#f59e0b', '#10b981', '#ec4899'];
    let deployConfig = null;
    let commitConfig = null;
    let editDeployConfig = null;
    let editCommitConfig = null;
    let statuses = {};
    let isRunning = false;
    let currentTab = 'deploy';

    function loadConfig() {
      // 탭별 설정 로드
      const savedDeploy = localStorage.getItem('dashboard-deploy-config');
      const savedCommit = localStorage.getItem('dashboard-commit-config');
      deployConfig = savedDeploy ? JSON.parse(savedDeploy) : DEFAULT_DEPLOY_CONFIG;
      commitConfig = savedCommit ? JSON.parse(savedCommit) : DEFAULT_COMMIT_CONFIG;

      // 상태 초기화
      deployConfig.projects.forEach(p => {
        statuses[`deploy-${p.id}`] = 'ready';
      });
      commitConfig.projects.forEach(p => {
        statuses[`commit-${p.id}`] = 'ready';
      });

      // 저장된 탭 복원
      const savedTab = localStorage.getItem('dashboard-current-tab');
      if (savedTab) {
        currentTab = savedTab;
        switchTab(currentTab);
      }
      render();
    }

    function switchTab(tab) {
      currentTab = tab;
      localStorage.setItem('dashboard-current-tab', tab);
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.tab:nth-child(${tab === 'deploy' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');

      // 탭별 설정 버튼 표시/숨김
      document.getElementById('deploy-config-section').style.display = tab === 'deploy' ? 'block' : 'none';
      document.getElementById('commit-config-section').style.display = tab === 'commit' ? 'block' : 'none';
      // 설정 패널 닫기
      document.getElementById('deploy-config-panel').classList.remove('show');
      document.getElementById('commit-config-panel').classList.remove('show');
    }

    function render() {
      renderDeployTab();
      renderCommitTab();
    }

    function renderDeployTab() {
      const statusBar = document.getElementById('deploy-status-bar');
      const cards = document.getElementById('deploy-cards');

      statusBar.innerHTML = deployConfig.projects.map(p => {
        const status = statuses[`deploy-${p.id}`] || 'ready';
        return `<div class="status-item ${status}">${p.label}: ${getStatusText(status)}</div>`;
      }).join('');

      cards.innerHTML = deployConfig.projects.map(p => `
        <div class="project-card">
          <div class="project-info">
            <div class="project-name">${p.label}</div>
            <div class="project-path" title="${p.deployScript}">${p.deployScript}</div>
          </div>
          <div class="project-actions">
            <button class="btn btn-deploy btn-small" onclick="deploy('${p.id}')" ${isRunning ? 'disabled' : ''}>Deploy</button>
          </div>
        </div>
      `).join('');

      document.getElementById('btn-deploy-all').disabled = isRunning;
    }

    function renderCommitTab() {
      const statusBar = document.getElementById('commit-status-bar');
      const cards = document.getElementById('commit-cards');

      statusBar.innerHTML = commitConfig.projects.map(p => {
        const status = statuses[`commit-${p.id}`] || 'ready';
        return `<div class="status-item ${status}">${p.label}: ${getStatusText(status)}</div>`;
      }).join('');

      cards.innerHTML = commitConfig.projects.map(p => `
        <div class="project-card">
          <div class="project-info">
            <div class="project-name">${p.label}</div>
            <div class="project-path" title="${p.path}">${p.path}</div>
          </div>
          <div class="project-actions">
            <button class="btn btn-commit btn-small" onclick="commit('${p.id}')" ${isRunning ? 'disabled' : ''}>Commit</button>
            <button class="btn btn-commit-push btn-small" onclick="commitAndPushDev('${p.id}')" ${isRunning ? 'disabled' : ''}>Commit & Push</button>
            <button class="btn btn-merge btn-small" onclick="mergeAndPush('${p.id}')" ${isRunning ? 'disabled' : ''}>Merge to dev</button>
          </div>
        </div>
      `).join('');

      document.getElementById('btn-commit-all').disabled = isRunning;
      document.getElementById('btn-push-all').disabled = isRunning;
    }

    function getStatusText(status) {
      switch(status) {
        case 'running': return 'Running...';
        case 'success': return 'Success';
        case 'error': return 'Failed';
        default: return 'Ready';
      }
    }

    function setStatus(projectId, type, status) {
      statuses[`${type}-${projectId}`] = status;
      render();
    }

    function addLog(text, className = '') {
      const log = document.getElementById('log');
      const div = document.createElement('div');
      div.className = `log-line ${className}`;
      div.textContent = text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // ===== Deploy =====
    async function deploy(projectId) {
      if (isRunning) return;
      const project = deployConfig.projects.find(p => p.id === projectId);
      if (!project?.deployScript) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Deploying ${project.label}...`, 'system');
      setStatus(projectId, 'deploy', 'running');

      await runSSE(`/api/deploy?projectId=${encodeURIComponent(project.deployProjectId)}&script=${encodeURIComponent(project.deployScript)}`, projectId, 'deploy', project.label);

      isRunning = false;
      render();
    }

    async function deployAll() {
      if (isRunning) return;
      isRunning = true;
      render();
      clearLog();

      for (const project of deployConfig.projects) {
        addLog(`[START] Deploying ${project.label}...`, 'system');
        setStatus(project.id, 'deploy', 'running');
        await runSSE(`/api/deploy?projectId=${encodeURIComponent(project.deployProjectId)}&script=${encodeURIComponent(project.deployScript)}`, project.id, 'deploy', project.label);
        addLog('');
      }

      addLog('[COMPLETE] All deployments finished!', 'system');
      isRunning = false;
      render();
    }

    // ===== Commit =====
    async function commit(projectId) {
      if (isRunning) return;
      const project = commitConfig.projects.find(p => p.id === projectId);
      if (!project) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Committing ${project.label}...`, 'system');
      setStatus(projectId, 'commit', 'running');

      await runSSE(`/api/commit?cwd=${encodeURIComponent(project.path)}`, projectId, 'commit', project.label);

      isRunning = false;
      render();
    }

    async function commitAll() {
      if (isRunning) return;
      isRunning = true;
      render();
      clearLog();

      for (const project of commitConfig.projects) {
        addLog(`[START] Committing ${project.label}...`, 'system');
        setStatus(project.id, 'commit', 'running');
        await runSSE(`/api/commit?cwd=${encodeURIComponent(project.path)}`, project.id, 'commit', project.label);
        addLog('');
      }

      addLog('[COMPLETE] All commits finished!', 'system');
      isRunning = false;
      render();
    }

    // ===== Push =====
    async function push(projectId) {
      if (isRunning) return;
      const project = commitConfig.projects.find(p => p.id === projectId);
      if (!project) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Pushing ${project.label}...`, 'system');
      setStatus(projectId, 'commit', 'running');

      await runSSE(`/api/push?cwd=${encodeURIComponent(project.path)}`, projectId, 'commit', project.label);

      isRunning = false;
      render();
    }

    async function pushAll() {
      if (isRunning) return;
      isRunning = true;
      render();
      clearLog();

      for (const project of commitConfig.projects) {
        addLog(`[START] Pushing ${project.label}...`, 'system');
        setStatus(project.id, 'commit', 'running');
        await runSSE(`/api/push?cwd=${encodeURIComponent(project.path)}`, project.id, 'commit', project.label);
        addLog('');
      }

      addLog('[COMPLETE] All pushes finished!', 'system');
      isRunning = false;
      render();
    }

    // ===== Commit & Push to dev =====
    async function commitAndPushDev(projectId) {
      if (isRunning) return;
      const project = commitConfig.projects.find(p => p.id === projectId);
      if (!project) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Commit & Push ${project.label} to development...`, 'system');
      setStatus(projectId, 'commit', 'running');

      await runSSE(`/api/commit-and-push-dev?cwd=${encodeURIComponent(project.path)}`, projectId, 'commit', project.label);

      isRunning = false;
      render();
    }

    // ===== Merge to dev =====
    async function mergeAndPush(projectId) {
      if (isRunning) return;
      const project = commitConfig.projects.find(p => p.id === projectId);
      if (!project) return;

      isRunning = true;
      render();
      clearLog();
      addLog(`[START] Merging ${project.label} to development...`, 'system');
      setStatus(projectId, 'commit', 'running');

      await runSSE(`/api/merge-dev?cwd=${encodeURIComponent(project.path)}`, projectId, 'commit', project.label);

      isRunning = false;
      render();
    }

    // ===== SSE Runner =====
    function runSSE(url, projectId, type, label) {
      return new Promise((resolve) => {
        const eventSource = new EventSource(url);

        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'stdout' || data.type === 'stderr') {
            addLog(data.text);
          } else if (data.type === 'done') {
            eventSource.close();
            if (data.code === 0) {
              addLog(`[DONE] ${label} completed successfully!`, 'system');
              setStatus(projectId, type, 'success');
            } else {
              addLog(`[ERROR] ${label} failed (exit code: ${data.code})`, 'error');
              setStatus(projectId, type, 'error');
            }
            resolve();
          } else if (data.type === 'error') {
            eventSource.close();
            addLog(`[ERROR] ${data.text}`, 'error');
            setStatus(projectId, type, 'error');
            resolve();
          }
        };

        eventSource.onerror = () => {
          eventSource.close();
          addLog('[ERROR] Connection error', 'error');
          setStatus(projectId, type, 'error');
          resolve();
        };
      });
    }

    // ===== Config =====
    function toggleConfig(tab) {
      const panel = document.getElementById(`${tab}-config-panel`);
      if (panel.classList.contains('show')) {
        panel.classList.remove('show');
      } else {
        if (tab === 'deploy') {
          editDeployConfig = JSON.parse(JSON.stringify(deployConfig));
        } else {
          editCommitConfig = JSON.parse(JSON.stringify(commitConfig));
          // 스캔 경로 복원
          setTimeout(restoreScanPath, 0);
        }
        renderConfigPanel(tab);
        panel.classList.add('show');
      }
    }

    function renderConfigPanel(tab) {
      const container = document.getElementById(`${tab}-project-list`);
      if (tab === 'deploy') {
        container.innerHTML = editDeployConfig.projects.map((p, i) => `
          <div class="project-config">
            <div class="project-header">
              <input class="input" style="font-weight:600;margin-bottom:8px;flex:1" value="${p.label}" placeholder="Label" onchange="updateEditProject('deploy', ${i}, 'label', this.value)">
              <button class="remove-btn" onclick="removeEditProject('deploy', ${i})">X</button>
            </div>
            <div class="config-field">
              <label class="label">Deploy Script</label>
              <input class="input" value="${p.deployScript || ''}" placeholder="/path/to/deploy-script.sh" onchange="updateEditProject('deploy', ${i}, 'deployScript', this.value)">
            </div>
            <div class="config-field">
              <label class="label">Deploy Project ID</label>
              <input class="input" value="${p.deployProjectId || ''}" placeholder="gcp-project-id" onchange="updateEditProject('deploy', ${i}, 'deployProjectId', this.value)">
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = editCommitConfig.projects.map((p, i) => `
          <div class="project-config">
            <div class="project-header">
              <input class="input" style="font-weight:600;margin-bottom:8px;flex:1" value="${p.label}" placeholder="Label" onchange="updateEditProject('commit', ${i}, 'label', this.value)">
              <button class="remove-btn" onclick="removeEditProject('commit', ${i})">X</button>
            </div>
            <div class="config-field">
              <label class="label">Project Path (git root)</label>
              <input class="input" value="${p.path || ''}" placeholder="/path/to/project" onchange="updateEditProject('commit', ${i}, 'path', this.value)">
            </div>
          </div>
        `).join('');
      }
    }

    function updateEditProject(tab, index, field, value) {
      const config = tab === 'deploy' ? editDeployConfig : editCommitConfig;
      config.projects[index][field] = value;
      if (field === 'label') {
        config.projects[index].id = value.toLowerCase().replace(/\s+/g, '-');
      }
    }

    function addProject(tab) {
      const config = tab === 'deploy' ? editDeployConfig : editCommitConfig;
      if (tab === 'deploy') {
        config.projects.push({
          id: `project-${Date.now()}`,
          label: 'New Project',
          deployScript: '',
          deployProjectId: ''
        });
      } else {
        config.projects.push({
          id: `project-${Date.now()}`,
          label: 'New Project',
          path: ''
        });
      }
      renderConfigPanel(tab);
    }

    function removeEditProject(tab, index) {
      const config = tab === 'deploy' ? editDeployConfig : editCommitConfig;
      config.projects.splice(index, 1);
      renderConfigPanel(tab);
    }

    function saveConfig(tab) {
      if (tab === 'deploy') {
        deployConfig = editDeployConfig;
        localStorage.setItem('dashboard-deploy-config', JSON.stringify(deployConfig));
        deployConfig.projects.forEach(p => { statuses[`deploy-${p.id}`] = 'ready'; });
      } else {
        commitConfig = editCommitConfig;
        localStorage.setItem('dashboard-commit-config', JSON.stringify(commitConfig));
        commitConfig.projects.forEach(p => { statuses[`commit-${p.id}`] = 'ready'; });
      }
      document.getElementById(`${tab}-config-panel`).classList.remove('show');
      render();
    }

    function cancelConfig(tab) {
      document.getElementById(`${tab}-config-panel`).classList.remove('show');
    }

    // Git 프로젝트 자동 스캔
    async function scanGitProjects() {
      const pathInput = document.getElementById('commit-scan-path');
      const rootPath = pathInput.value.trim();
      if (!rootPath) {
        alert('스캔할 경로를 입력하세요.');
        return;
      }

      try {
        const res = await fetch(`/api/scan-git-projects?path=${encodeURIComponent(rootPath)}`);
        const data = await res.json();

        if (data.error) {
          alert(`스캔 실패: ${data.error}`);
          return;
        }

        if (data.projects.length === 0) {
          alert('해당 경로에서 git 프로젝트를 찾을 수 없습니다.');
          return;
        }

        // 기존 프로젝트와 병합 (중복 제거)
        const existingPaths = new Set(editCommitConfig.projects.map(p => p.path));
        for (const project of data.projects) {
          if (!existingPaths.has(project.path)) {
            editCommitConfig.projects.push(project);
          }
        }

        // 스캔 경로 저장
        localStorage.setItem('dashboard-commit-scan-path', rootPath);

        renderConfigPanel('commit');
        alert(`${data.projects.length}개의 git 프로젝트를 찾았습니다.`);
      } catch (err) {
        alert(`스캔 중 오류 발생: ${err.message}`);
      }
    }

    // 저장된 스캔 경로 복원
    function restoreScanPath() {
      const savedPath = localStorage.getItem('dashboard-commit-scan-path');
      if (savedPath) {
        const input = document.getElementById('commit-scan-path');
        if (input) input.value = savedPath;
      }
    }

    // 도움말 모달 토글
    function toggleHelp() {
      const modal = document.getElementById('help-modal');
      modal.classList.toggle('show');
    }

    loadConfig();
    // 초기 탭 설정 버튼 표시
    switchTab(currentTab);
  </script>
</body>
</html>
